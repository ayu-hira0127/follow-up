server {
    # ポート80でリッスン（HTTP通信を受け付ける）
    listen 80;
    
    # サーバー名（localhostでアクセス）
    server_name localhost;
    
    # ドキュメントルート（LaravelのpublicフォルダがWebサーバーのルート）
    root /var/www/html/public;
    
    # デフォルトで表示するファイル（優先順位順）
    # index.php → index.html → index.htm の順で探す
    index index.php index.html index.htm;

    # 誰がいつどのページにアクセスしたかを記録
    access_log /var/log/nginx/access.log;
    # エラーが発生した際の詳細情報を記録
    error_log /var/log/nginx/error.log;

    # セキュリティ設定（ディレクトリ一覧表示を無効化）
    # ディレクトリにindexファイルがない場合、ファイル一覧を表示しない
    autoindex off;

    # 文字エンコーディング
    # UTF-8を使用
    charset utf-8;

    # Laravel用のルーティング設定
    # すべてのリクエストに対して、以下の順序でファイルを探す
    location / {
        # 1. リクエストされたURIそのままのファイルを探す
        # 2. そのURIをディレクトリとして探す
        # 3. 見つからなければ、Laravelのindex.phpに処理を渡す（Laravelのルーティング）
        try_files $uri $uri/ /index.php?$query_string;
    }

    # PHPファイルの処理
    # .phpで終わるファイルへのリクエストを処理
    location ~ \.php$ {
        # PHP-FPMコンテナ（php-app）の9000番ポートに処理を転送
        # PHPファイルが実行される
        fastcgi_pass php-app:9000;
        
        # PHPファイルのパスを指定（どのPHPファイルを実行するか）
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        
        # FastCGIの標準パラメータを読み込む
        include fastcgi_params;
        
        # Authorizationヘッダーの処理
        # API認証などで使用される認証情報をPHPに渡す
        fastcgi_param HTTP_AUTHORIZATION $http_authorization;
        
        # X-XSRF-Tokenヘッダーの処理
        # LaravelのCSRF保護機能で使用されるトークンをPHPに渡す
        fastcgi_param HTTP_X_XSRF_TOKEN $http_x_xsrf_token;
        
        # タイムアウト設定
        # PHP-FPMからの応答を300秒（5分）まで待つ
        fastcgi_read_timeout 300;
    }

    # 静的ファイルのキャッシュ設定
    # 画像、CSS、JavaScript、フォントなどの静的ファイルをキャッシュ
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        # キャッシュの有効期限を1年に設定
        expires 1y;
        # ブラウザにキャッシュを保存するよう指示
        add_header Cache-Control "public, immutable";
        # 静的ファイルへのアクセスはログに記録しない（ログファイルの肥大化を防ぐ）
        access_log off;
    }

    # 隠しファイルへのアクセスを拒否
    # .で始まるファイル（.env、.gitなど）へのアクセスを拒否
    location ~ /\. {
        # すべてのアクセスを拒否
        deny all;
        # ログに記録しない
        access_log off;
        log_not_found off;
    }

    # favicon.icoの処理
    # ブラウザが自動的にリクエストするファビコンアイコンの処理
    location = /favicon.ico {
        # ログに記録しない（不要なログを減らす）
        access_log off;
        log_not_found off;
    }

    # robots.txtの処理
    # 検索エンジンのクローラー向けの設定ファイルの処理
    location = /robots.txt {
        # ログに記録しない（不要なログを減らす）
        access_log off;
        log_not_found off;
    }
}



